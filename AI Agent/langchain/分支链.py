import time
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.prompts import PromptTemplate
from langchain_core.runnables import RunnablePassthrough, RunnableBranch
from langchain_core.output_parsers import StrOutputParser
from langchain_core.callbacks import BaseCallbackHandler

from get_api_config import GetApiConfig
api_config = GetApiConfig()

import os
os.environ["HTTP_PROXY"] = "http://127.0.0.1:10809"
os.environ["HTTPS_PROXY"] = "http://127.0.0.1:10809"
llm = ChatGoogleGenerativeAI(
    api_key=api_config.get_gemini_api_key(2),
    model="models/gemini-2.0-flash",
    temperature=0.7,
    timeout=30,
    max_retries=0  # 禁用重试，快速失败
)

tech_prompt = PromptTemplate.from_template(
    """
    获取科技关键字：{question}
    """
)
culture_prompt = PromptTemplate.from_template(
    """
    获取文化关键字：{question}
    """
)
other_prompt = PromptTemplate.from_template(
    """
    获取其他关键字：{question}
    """
)
result_prompt = PromptTemplate.from_template(
    """
    基于以下摘要：{summary}，生成一个详细的介绍。
    """
)

tech_chain = tech_prompt | llm | StrOutputParser()
culture_chain = culture_prompt | llm | StrOutputParser()
other_chain = other_prompt | llm | StrOutputParser()
result_chain = result_prompt | llm | StrOutputParser()
# 交叉链实际上是一个分支，可以在此处做一些不一样的处理来改变后续处理的走向
pipeline = RunnableBranch((lambda x : "科技" in x["question"], tech_chain),
        (lambda x : "文化" in x["question"], culture_chain),
        other_chain     # 默认分支
        )| {"summary": RunnablePassthrough()} | result_chain

# 设置回调函数
class MyCallbackHandler(BaseCallbackHandler):
    def on_chain_start(self, serialized, inputs, **kwargs):
        print(f"Chain {serialized['id']} started with inputs: {inputs}")
    def on_chain_end(self, outputs, **kwargs):
        print(f"Chain ended with outputs: {outputs}")
    def on_chain_error(self, error, **kwargs):
        print(f"Chain error: {error}")
print(pipeline.invoke({"question":"如何评价文化书籍：《唐顿庄园》，100字"}))
time.sleep(2)
print(pipeline.invoke({"question":"如何评价科技公司苹果在2007年推出的iphone，100字"}))
time.sleep(2)
print(pipeline.invoke({"question":"如何评价拿破仑，100字"}))

# **深入《唐顿庄园》的世界：官方书籍带您领略幕后辉煌与文化精髓**
#
# 《唐顿庄园》以其精美的服饰、跌宕起伏的剧情和对英国贵族生活的细腻刻画，赢得了全球观众的喜爱。现在，通过官方书籍，您将有机会更深入地探索这个令人着迷的世界，揭开隐藏在剧集背后的文化内涵和历史背景。
#
# 这本书籍不仅仅是对剧情的简单回顾，而是一次精心策划的文化之旅。它以**精美的图片**为载体，再现了唐顿庄园的奢华场景、人物的华丽服饰和英国乡村的迷人风光，让您仿佛身临其境，重温剧中的经典瞬间。
#
# 更重要的是，本书籍深入挖掘了剧集背后的**幕后故事**，揭示了制作团队的匠心独运和演员们的精彩演绎。您将了解到场景搭建的细节、服装设计的灵感来源、以及演员们对角色的理解和诠释。
#
# 此外，本书籍还着重**解析了剧中人物的生活方式和礼仪规范**，例如用餐礼仪、社交规则、服饰搭配等等。这些看似繁琐的细节，却真实地反映了英国贵族阶层的日常状态和价值观念。通过了解这些礼仪，您可以更加理解剧中人物的行为动机和情感表达。
#
# 更进一步，本书籍还将《唐顿庄园》置于更广阔的**历史背景**下，**揭示了英国贵族阶层的历史变迁和社会百态**。从一战的爆发到爵位继承的困境，从社会阶层的流动到科技进步的冲击，本书籍将剧中人物的命运与时代背景紧密相连，让您在欣赏剧情的同时，也能了解到英国历史的重要时刻。
#
# 总而言之，这本《唐顿庄园》官方书籍是一本集视觉享受、知识普及和文化探索于一体的佳作。通过阅读此书，您不仅可以更全面地理解《唐顿庄园》所蕴含的**文化价值**，例如贵族精神、阶级观念、传统与变革等等，还可以更深刻地**体验这部经典作品**所带来的感动和思考。无论是《唐顿庄园》的忠实粉丝，还是对英国历史文化感兴趣的读者，都将在这本书中找到属于自己的乐趣。
# ## iPhone：科技界的革命性产品，智能手机时代的开创者
#
# 2007年，苹果公司推出的iPhone不仅仅是一款新手机，更是一场科技界的革命。它以其前所未有的创新设计和功能，重新定义了移动通信和计算的方式，并迅速成为行业标杆，深刻影响着人们的生活和工作。
#
# **一、开创智能手机时代：**
#
# 在iPhone诞生之前，手机市场充斥着按键繁琐、功能单一的传统手机。iPhone的出现，彻底打破了这种局面，宣告了智能手机时代的到来。它不再仅仅是通讯工具，而是一个集通讯、娱乐、信息获取、办公于一体的移动计算平台。
#
# **二、革命性的设计与功能：**
#
# iPhone之所以能够颠覆市场，离不开其革命性的设计和功能：
#
# *   **多点触控屏幕：** iPhone抛弃了传统的物理按键，采用了一块巨大的多点触控屏幕。用户可以直接用手指在屏幕上进行操作，例如滑动、缩放、点击等，操作体验流畅直观，彻底改变了人机交互的方式。
# *   **App Store生态系统：** iPhone的成功，App Store功不可没。苹果为开发者提供了一个开放的平台，让他们能够开发各种各样的应用程序，极大地扩展了iPhone的功能。用户可以通过App Store下载和安装自己需要的应用程序，满足不同的需求。
# *   **强大的硬件性能：** iPhone搭载了强大的处理器和内存，能够流畅运行各种应用程序和游戏。它还配备了高分辨率的摄像头、Wi-Fi、蓝牙等功能，满足了用户对移动娱乐和信息获取的需求。
#
# **三、颠覆传统手机厂商格局：**
#
# iPhone的出现，对传统手机厂商造成了巨大的冲击。那些固守传统设计和功能的厂商，逐渐被市场淘汰。而那些能够快速适应市场变化，推出具有创新性的智能手机的厂商，才得以生存和发展。
#
# **四、推动移动互联网的蓬勃发展：**
#
# iPhone的普及，极大地推动了移动互联网的蓬勃发展。随着越来越多的人使用智能手机上网，移动互联网的内容和应用也越来越丰富。人们可以通过手机浏览网页、观看视频、社交聊天、在线购物、移动支付等等，移动互联网已经成为人们生活中不可或缺的一部分。
#
# **五、对人们的生活和工作产生深远影响：**
#
# iPhone的出现，对人们的生活和工作产生了深远的影响：
#
# *   **改变了人们的通讯方式：** 人们可以通过手机进行语音通话、视频聊天、发送短信、电子邮件等等，通讯方式更加便捷高效。
# *   **改变了人们的娱乐方式：** 人们可以通过手机玩游戏、看电影、听音乐、阅读电子书等等，娱乐方式更加丰富多彩。
# *   **改变了人们的工作方式：** 人们可以通过手机处理邮件、编辑文档、进行视频会议等等，工作方式更加灵活高效。
# *   **改变了人们的社交方式：** 人们可以通过手机进行社交聊天、分享生活点滴、结交新朋友等等，社交方式更加便捷多样。
#
# **总结：**
#
# iPhone的诞生，是科技发展史上的一个重要里程碑。它以其革命性的设计和功能，开创了智能手机时代，颠覆了传统手机厂商的格局，推动了移动互联网的蓬勃发展，并对人们的生活和工作产生了深远影响。可以说，iPhone不仅仅是一款手机，更是一种生活方式的象征。它改变了我们与世界互动的方式，开启了一个全新的移动互联时代。
# 好的，下面是一个基于摘要的详细介绍，更深入地探讨了拿破仑的复杂性：
#
# **拿破仑·波拿巴：改革者、军事天才与破坏性的征服者**
#
# 拿破仑·波拿巴，无疑是欧洲历史上最具争议、也最具影响力的人物之一。他的人生轨迹如同戏剧般跌宕起伏，从法国大革命的浪潮中崛起，最终陨落在遥远的流放地。他既是卓越的军事家和政治家，为法国带来了稳定与改革，又是野心勃勃的征服者，给欧洲大陆带来了战火与伤亡。要全面理解拿破仑，必须正视他身上的多重矛盾，以及他对欧洲历史产生的深远影响。
#
# **大革命的继承者与秩序的重建者：**
#
# 法国大革命带来的动荡与混乱，为拿破仑的崛起提供了舞台。他凭借卓越的军事才能和政治手腕，平息了国内的纷争，结束了革命的混乱局面，并逐步建立起一个强大的中央集权政府。拿破仑深知，仅仅依靠武力无法长久统治，因此他积极推行了一系列改革，旨在巩固统治，提升法国的国力。
#
# *   **《拿破仑法典》：** 这是拿破仑最重要的遗产之一。这部法典将大革命的许多原则，如法律面前人人平等、保护私有财产等，以法律的形式固定下来。它不仅影响了法国，还被许多欧洲国家所借鉴，成为近代法律体系的重要组成部分。
# *   **行政改革：** 拿破仑对法国的行政区划进行了重新划分，建立了更加高效的官僚体系。他强调选贤任能，提拔了一批有才干的官员，为国家的管理提供了保障。
# *   **经济发展：** 拿破仑采取了一系列措施来促进法国的经济发展，如建立法兰西银行、鼓励工商业等。这些措施在一定程度上促进了法国的经济繁荣。
# *   **教育改革：** 拿破仑重视教育，建立了公立教育体系，培养了一批人才，为国家的建设提供了智力支持。
#
# **军事天才与征服战争：**
#
# 拿破仑是一位杰出的军事家，他的军事才能在战场上得到了充分的展现。他善于运用战略战术，能够迅速掌握战场局势，并做出正确的决策。他率领的军队几乎战无不胜，征服了欧洲大陆的大部分地区。
#
# *   **辉煌的战役：** 从意大利战役到奥斯特里茨战役，拿破仑的军事生涯充满了辉煌的胜利。他以其独特的战术和强大的军队，横扫欧洲大陆，建立起一个庞大的帝国。
# *   **大陆封锁政策：** 为了打击英国，拿破仑推行了大陆封锁政策，试图切断英国与欧洲大陆的贸易联系。然而，这一政策也对欧洲各国的经济造成了损害，最终导致了反拿破仑联盟的形成。
#
# **帝国的崩溃与历史的遗产：**
#
# 拿破仑的野心最终导致了他的帝国崩溃。对俄国的入侵失败是拿破仑走向衰落的转折点。此后，欧洲各国组成反法联盟，最终在滑铁卢战役中彻底击败了拿破仑。他被流放到圣赫勒拿岛，在那里度过了余生。
#
# 尽管拿破仑的帝国最终崩溃，但他对欧洲历史的影响是深远的。
#
# *   **传播了革命思想：** 拿破仑的征服战争，将法国大革命的思想传播到欧洲各地，促进了欧洲的民族觉醒和自由主义运动的发展。
# *   **改变了欧洲的政治格局：** 拿破仑战争打破了欧洲的旧秩序，促进了欧洲各国的重新组合，为近代欧洲的形成奠定了基础。
# *   **留下了法律和制度遗产：** 《拿破仑法典》等法律和制度，被许多国家所借鉴，对近代法律体系的形成产生了重要影响。
#
# **总结：**
#
# 拿破仑是一位复杂的历史人物，他既是改革者和军事天才，又是野心勃勃的征服者。他为法国带来了稳定和改革，也给欧洲带来了战火和伤亡。他的历史功过，至今仍然备受争议。 然而，不可否认的是，拿破仑对欧洲历史产生了深远的影响，他的遗产将永远被人们所铭记。他是一位充满矛盾、极具争议，却又影响深远的历史伟人。

